Code and functions for ray
